{% comment %}
  =============================================================================
  COMPONENT: Chart Assets
  usage: {% render 'chart_assets' %}
  =============================================================================
{% endcomment %}

{% template chart_assets %}
  <script src="https://usetrmnl.com/js/highcharts/12.3.0/highcharts.js"></script>
  <script src="https://usetrmnl.com/js/highcharts/12.3.0/highcharts-more.js"></script>
  <script src="https://usetrmnl.com/js/highcharts/12.3.0/pattern-fill.js"></script>
{% endtemplate %}

{% comment %}
  =============================================================================
  COMPONENT: Head Assets
  usage: {% render 'head_assets' %}
  =============================================================================
{% endcomment %}

{% template head_assets %}
  {% render 'chart_assets' %}
{% endtemplate %}

{% comment %}
  =============================================================================
  COMPONENT: Title Bar
  usage: {% render 'title_bar', instance: 'Energy Prices' %}
  =============================================================================
{% endcomment %}

{% template title_bar %}
  <div class="title_bar">
    <img class="image" src="https://usetrmnl.com/images/plugins/weather/wi-lightning.svg">
    <span class="title">Frank Energie</span>
    <span class="instance">{{ instance | default: "Energy Prices" }}</span>
  </div>
{% endtemplate %}

{% comment %}
  =============================================================================
  COMPONENT: Stat Grid (Highest/Lowest/Now)
  Usage: {% render 'stat_grid', data: electricity, currency: "€" %}
  =============================================================================
{% endcomment %}

{% template stat_grid %}
  {% if data.size > 0 %}
    {% assign highest = data | sort: "marketPrice" | last %}
    {% assign lowest = data | sort: "marketPrice" | first %}

    {% assign current_timestamp = "now" | date: "%s" | plus: trmnl.user.utc_offset %}
    {% assign current_hour = current_timestamp | date: "%H" %}
    {% assign current_time_str = current_timestamp | date: "%H:%M" %}

    {% assign current_item = data[0] %}

    {% for item in data %}
      {% assign item_time = item.from | date: "%s" %}
      {% assign item_hour = item_time | date: "%H" %}

      {% if item_hour == current_hour %}
        {% assign current_item = item %}
        {% break %}
      {% endif %}
    {% endfor %}

    {% assign highest_total = highest.marketPrice | plus: highest.marketPriceTax | plus: highest.sourcingMarkupPrice | plus: highest.energyTaxPrice %}
    {% assign lowest_total = lowest.marketPrice | plus: lowest.marketPriceTax | plus: lowest.sourcingMarkupPrice | plus: lowest.energyTaxPrice %}
    {% assign current_total = current_item.marketPrice | plus: current_item.marketPriceTax | plus: current_item.sourcingMarkupPrice | plus: current_item.energyTaxPrice %}

    {% if variant == 'compact' %}
      <div class="flex gap--space-between w--full">
        <div class="item">
          <div class="content">
            <div>
              <span class="value value--tnums value--small">{{ highest_total | round: 2 }}</span>
              <span class="label label--gray">{{ currency }}</span>
            </div>
            <span class="label label--small">High @ {{ highest.from | date: "%H:%M" }}</span>
          </div>
        </div>
        <div class="item">
          <div class="content">
            <div>
              <span class="value value--tnums value--small">{{ lowest_total | round: 2 }}</span>
              <span class="label label--gray">{{ currency }}</span>
            </div>
            <span class="label label--small">Low @ {{ lowest.from | date: "%H:%M" }}</span>
          </div>
        </div>
        <div class="item">
          <div class="content">
            <div>
              <span class="value value--tnums value--small">{{ current_total | round: 2 }}</span>
              <span class="label label--gray">{{ currency }}</span>
            </div>
            <span class="label label--small">Now @ {{ current_time_str }}</span>
          </div>
        </div>
      </div>
    {% else %}
      <div class="grid grid--cols-3">
        <div class="item item--emphasis-3">
          <div class="meta"></div>
          <div class="content">
            <div>
              <span class="value value--tnums value--small">{{ highest_total | round: 2 }}</span>
              <span class="label label--gray">{{ currency }}</span>
            </div>
            <span class="label">Highest @ {{ highest.from | date: "%H:%M" }}</span>
          </div>
        </div>
        <div class="item item--emphasis-2">
          <div class="meta"></div>
          <div class="content">
            <div>
              <span class="value value--tnums value--small">{{ lowest_total | round: 2 }}</span>
              <span class="label label--gray">{{ currency }}</span>
            </div>
            <span class="label">Lowest @ {{ lowest.from | date: "%H:%M" }}</span>
          </div>
        </div>
        <div class="item item--emphasis-1">
          <div class="meta"></div>
          <div class="content">
            <div>
              <span class="value value--tnums value--small">{{ current_total | round: 2 }}</span>
              <span class="label label--gray">{{ currency }}</span>
            </div>
            <span class="label">Now @ {{ current_time_str }}</span>
          </div>
        </div>
      </div>
    {% endif %}
  {% else %}
    <div class="grid grid--cols-3">
      <div class="item">
        <div class="content">
          <span class="label">No Data</span>
        </div>
      </div>
    </div>
  {% endif %}
{% endtemplate %}

{% comment %}
  =============================================================================
  COMPONENT: Secondary Stat Grid (Highest/Lowest/Now)
  Usage: {% render 'secondary_stat_grid', data: gas, currency: "€", label_prefix: "Gas" %}
  =============================================================================
{% endcomment %}

{% template secondary_stat_grid %}
  {% if data.size > 0 %}
    {% assign highest = data | sort: "marketPrice" | last %}
    {% assign lowest = data | sort: "marketPrice" | first %}

    {% assign current_timestamp = "now" | date: "%s" | plus: trmnl.user.utc_offset %}
    {% assign current_hour = current_timestamp | date: "%H" %}
    {% assign current_time_str = current_timestamp | date: "%H:%M" %}

    {% assign current_item = data[0] %}

    {% for item in data %}
      {% assign item_time = item.from | date: "%s" %}
      {% assign item_hour = item_time | date: "%H" %}

      {% if item_hour == current_hour %}
        {% assign current_item = item %}
        {% break %}
      {% endif %}
    {% endfor %}

    {% assign highest_total = highest.marketPrice | plus: highest.marketPriceTax | plus: highest.sourcingMarkupPrice | plus: highest.energyTaxPrice %}
    {% assign lowest_total = lowest.marketPrice | plus: lowest.marketPriceTax | plus: lowest.sourcingMarkupPrice | plus: lowest.energyTaxPrice %}
    {% assign current_total = current_item.marketPrice | plus: current_item.marketPriceTax | plus: current_item.sourcingMarkupPrice | plus: current_item.energyTaxPrice %}

    <div class="grid grid--cols-3">
      <div class="item item--emphasis-3">
        <div class="meta"></div>
        <div class="content">
          <div>
            <span class="value value--tnums value--small">{{ highest_total | round: 2 }}</span>
            <span class="label label--gray">{{ currency }}</span>
          </div>
          <span class="label">{{ label_prefix }} | Highest @ {{ highest.from | date: "%H:%M" }}</span>
        </div>
      </div>
      <div class="item item--emphasis-2">
        <div class="meta"></div>
        <div class="content">
          <div>
            <span class="value value--tnums value--small">{{ lowest_total | round: 2 }}</span>
            <span class="label label--gray">{{ currency }}</span>
          </div>
          <span class="label">{{ label_prefix }} | Lowest @ {{ lowest.from | date: "%H:%M" }}</span>
        </div>
      </div>
      <div class="item item--emphasis-1">
        <div class="meta"></div>
        <div class="content">
          <div>
            <span class="value value--tnums value--small">{{ current_total | round: 2 }}</span>
            <span class="label label--gray">{{ currency }}</span>
          </div>
          <span class="label">{{ label_prefix }} | Now @ {{ current_time_str }}</span>
        </div>
      </div>
    </div>
  {% else %}
    <div class="grid grid--cols-3">
      <div class="item">
        <div class="content">
          <span class="label">No Data</span>
        </div>
      </div>
    </div>
  {% endif %}
{% endtemplate %}

{% comment %}
  =============================================================================
  COMPONENT: Energy Chart
  =============================================================================
{% endcomment %}

{% template energy_chart %}
  <div id="{{ id }}" class="w--full {% if variant == 'full' %}flex--grow{% else %}h--full{% endif %}"></div>

  <script type="text/javascript">
    var rawElectricity = [
      {% for item in electricity %}
        {% assign t_price = item.marketPrice | plus: item.marketPriceTax | plus: item.sourcingMarkupPrice | plus: item.energyTaxPrice %}
        { "from": "{{ item.from | date: '%Y-%m-%dT%H:%M:%SZ' }}", "till": "{{ item.till | date: '%Y-%m-%dT%H:%M:%SZ' }}", "total_price": {{ t_price | default: 0 }} }
        {% unless forloop.last %},{% endunless %}
      {% endfor %}
    ];
    
    var rawGas = [
      {% for item in gas %}
        {% assign t_price = item.marketPrice | plus: item.marketPriceTax | plus: item.sourcingMarkupPrice | plus: item.energyTaxPrice %}
        { "from": "{{ item.from | date: '%Y-%m-%dT%H:%M:%SZ' }}", "till": "{{ item.till | date: '%Y-%m-%dT%H:%M:%SZ' }}", "total_price": {{ t_price | default: 0 }} }
        {% unless forloop.last %},{% endunless %}
      {% endfor %}
    ];

    function transformData(data) {
      if (!data) return [];
      return data.map(function(item) {
        var price = parseFloat(item.total_price);
        if (isNaN(price)) { price = 0; }
        return [
          new Date(item.from).getTime(),
          Math.round(price * 100) / 100
        ];
      });
    }

    var electricityData = transformData(rawElectricity);
    var gasData = transformData(rawGas);

    (function() {
      var chartConfig = {
        chart: {
          type: "spline",
          height: null, // keep null to let it fill container
          width: null,
          animation: false,
          backgroundColor: 'transparent',
          {% if variant == 'sparkline' %}
            margin: [0, 0, 0, 0],
            spacing: [0, 0, 0, 0],
          {% else %}
            spacing: [10, 10, 5, 10],
          {% endif %}
          events: {
            load: function() {
              // Force reflow after chart loads to ensure pattern fills render correctly
              var chart = this;
              setTimeout(function() {
                chart.reflow();
              }, 50);
            }
          }
        },
        accessibility: { enabled: false },
        title: { text: null },
        plotOptions: {
          series: {
            animation: false,
            enableMouseTracking: false,
            states: { hover: { enabled: false } },
            marker: { enabled: false }
          }
        },
        series: [
          {% assign chart_resource = resource_type | default: trmnl.plugin_settings.custom_fields_values.resource_type | default: 'Electricity' %}
          {% if chart_resource == 'Gas' %}
            {
              data: gasData,
              lineWidth: 4,
              color: "#000000",
              name: "Gas",
              zIndex: 2
            }
          {% else %}
            {
              data: electricityData,
              lineWidth: 4,
              color: "#000000",
              name: "Electricity",
              zIndex: 2
            }
          {% endif %}
        ],
        tooltip: { enabled: false },
        legend: { enabled: false },
        yAxis: {
          {% if variant == 'sparkline' %}
            visible: false,
          {% else %}
            labels: { style: { fontSize: "16px", color: "#000000" } },
            gridLineDashStyle: "shortdot",
            gridLineWidth: 1,
            gridLineColor: "#000000",
            tickAmount: 5,
            title: { text: null }
          {% endif %}
        },
        xAxis: {
          {% if variant == 'sparkline' %}
            visible: false,
          {% else %}
            type: "datetime",
            labels: { style: { fontSize: "16px", color: "#000000" }, padding: 5, y: 25 },
            lineWidth: 0,
            gridLineDashStyle: "dot",
            tickWidth: 1,
            tickLength: 0,
            gridLineWidth: 1,
            gridLineColor: "#000000",
            tickPixelInterval: 120,
            title: { text: null },
            plotLines: [{
              value: new Date("{{ 'now' | date: '%s' | plus: trmnl.user.utc_offset | date: '%Y-%m-%dT%H:%M:%S' }}").getTime(),
              color: "#000000",
              width: 2,
              dashStyle: "Dash",
              zIndex: 5,
              label: {
                text: "{{ 'now' | date: '%s' | plus: trmnl.user.utc_offset | date: '%H:%M' }}",
                style: { fontSize: "12px", fontWeight: "bold", color: "#000000" },
                y: -10,
                x: 5
              }
            }]
          {% endif %}
        },
        credits: { enabled: false }
      };

      // Wait for DOM to be ready before creating chart
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          Highcharts.chart("{{ id }}", chartConfig);
        });
      } else {
        Highcharts.chart("{{ id }}", chartConfig);
      }
    })();
  </script>
{% endtemplate %}